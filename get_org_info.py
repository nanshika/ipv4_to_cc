# python get_org_info.py
# -*- coding: utf-8 -*-
#
import requests, urllib, hashlib, os, re, subprocess, datetime, time, random
from bs4 import BeautifulSoup
from urllib.parse import urlparse
import ipaddress
headers = { 'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3538.9 Safari/537.36' }

home_path = ''

def decimalip_range(ip_net):
    ip_s = str(ipaddress.ip_network(ip_net)[0])
    ip_e = str(ipaddress.ip_network(ip_net)[-1])
    i = ip_s.split('.')
    deci_ip_s = (int(i[0]) << 24) + (int(i[1]) << 16) + (int(i[2]) << 8) + int(i[3])
    i = ip_e.split('.')
    deci_ip_e = (int(i[0]) << 24) + (int(i[1]) << 16) + (int(i[2]) << 8) + int(i[3])
    #print(str(deci_ip_s) + '\t' + str(deci_ip_e))
    return(str(deci_ip_s) + '\t' + str(deci_ip_e))

tar_org = [
    '宇都宮ケーブルテレビ株式会社',
    '宮城ケーブルテレビ株式会社',
    '宮崎ケーブルテレビ株式会社',
    '宮銀コンピューターサービス株式会社',
    '富士ソフト株式会社',
    '富士通クラウドテクノロジーズ株式会社',
    '富士通株式会社',
    '富士通関西中部ネットテック株式会社',
    '富山県',
    '射水ケーブルネットワーク株式会社',
    '山口ケーブルビジョン株式会社',
    '山梨CATV株式会社',
    '山陰ケーブルビジョン株式会社',
    '岡山ネットワーク株式会社',
    '岡山県',
    '岡山県久米郡美咲町',
    '広島県',
    '彩ネット株式会社',
    '日商エレクトロニクス株式会社',
    '日本たばこ産業株式会社',
    '日本インターネットアクセス株式会社',
    '日本インターネットエクスチェンジ株式会社',
    '日本ネットワークイネイブラー株式会社',
    '日本中央テレビ株式会社',
    '日本情報通信株式会社',
    '日本通信株式会社',
    '日本電気株式会社',
    '旭化成ネットワークス株式会社',
    '有限会社クロスコネクト新潟',
    '有限会社ジーエヌエー',
    '有限会社ティ・エイ・エム',
    '有限会社ナインレイヤーズ',
    '有限会社フェイズワン',
    '有限会社銀座堂',
    '有限責任事業組合かもいけねっと',
    '本庄ケーブルテレビ株式会社',
    '本田技研工業株式会社',
    '東京ケーブルネットワーク株式会社',
    '東京ベイネットワーク株式会社',
    '東北インテリジェント通信株式会社',
    '東日本電信電話株式会社',
    '東邦ガス情報システム株式会社',
    '松阪ケーブルテレビ・ステーション株式会社',
    '株式会社  吉蔵エックスワイゼットソリューションズ',
    '株式会社 QUICK',
    '株式会社 USEN',
    '株式会社 つくばインターネットサービス',
    '株式会社 インターリンク',
    '株式会社 ケーブルメディアワイワイ',
    '株式会社 サーフライン',
    '株式会社 ソラコム',
    '株式会社 テレビ津山',
    '株式会社 トコちゃんねる静岡',
    '株式会社 ドリーム・トレイン・インターネット',
    '株式会社 ドルフィンインターナショナル',
    '株式会社 ネスク',
    '株式会社 バリューコア',
    '株式会社 ブイ・アール・テクノセンター',
    '株式会社 ベッコアメ・インターネット',
    '株式会社 五島テレビ',
    '株式会社 創風システム',
    '株式会社 南日本情報処理センター',
    '株式会社 吉備ケーブルテレビ',
    '株式会社 多摩テレビ',
    '株式会社 帯広シティーケーブル',
    '株式会社 石川コンピュータ・センター',
    '株式会社ASJ',
    '株式会社BLESS',
    '株式会社CAC',
    '株式会社DIX',
    '株式会社GENESIS',
    '株式会社GLBBジャパン',
    '株式会社Geolocation Technology',
    '株式会社HBA',
    '株式会社IDCフロンティア',
    '株式会社ISAO',
    '株式会社JWAY',
    '株式会社KDDIウェブコミュニケーションズ',
    '株式会社LogicLinks',
    '株式会社NS・コンピュータサービス',
    '株式会社PFU',
    '株式会社QTnet',
    '株式会社RELATION',
    '株式会社STNet',
    '株式会社TCP',
    '株式会社TOKAIコミュニケーションズ',
    '株式会社Top Cloud',
    '株式会社VERVE',
    '株式会社YYY',
    '株式会社ZTV',
    '株式会社mirai-bs',
    '株式会社trunk',
    '株式会社えむぼま',
    '株式会社ぐるなび',
    '株式会社さくらケーシーエス',
    '株式会社ちゅピＣＯＭひろしま',
    '株式会社ちゅピＣＯＭふれあい',
    '株式会社はまなすインフォメーション',
    '株式会社アイピーコア',
    '株式会社アイ・キャン',
    '株式会社アイ・シー・シー',
    '株式会社アイ・ピー・エス',
    '株式会社アキュテクス',
    '株式会社アクセルネットワークス',
    '株式会社アットアイ',
    '株式会社アット東京',
    '株式会社アップライト',
    '株式会社アドバンスコープ',
    '株式会社アミックスコム',
    '株式会社アールワークス',
    '株式会社インターネットイニシアティブ',
    '株式会社インターネット尾張',
    '株式会社インテック',
    '株式会社イージェーワークス',
    '株式会社イーツ',
    '株式会社ウインテックコミュニケーションズ',
    '株式会社エアネット',
    '株式会社エキスパート',
    '株式会社エクザム',
    '株式会社エスエスアイ・ラボ',
    '株式会社エディオン',
    '株式会社エヌアイエスプラス',
    '株式会社エヌディエス',
    '株式会社エヌ・シィ・ティ',
    '株式会社エヌ・ティ・ティ ピー・シー コミュニケーションズ',
    '株式会社エヌ・ティ・ティエムイー',
    '株式会社エヌ・ティ・ティ・データ',
    '株式会社エネルギア・コミュニケーションズ',
    '株式会社エフレジ',
    '株式会社エム・ビー・エス',
    '株式会社エースウェア',
    '株式会社エーティーワークス',
    '株式会社オノコム',
    '株式会社オプテージ',
    '株式会社オーシーシー',
    '株式会社オージス総研',
    '株式会社オービック',
    '株式会社カイクリエイツ',
    '株式会社カカクコム',
    '株式会社キッズウェイ',
    '株式会社キャッチネットワーク',
    '株式会社キューデンインフォコム',
    '株式会社クルーグ',
    '株式会社クロノス',
    '株式会社グローバルネットコア',
    '株式会社ケイアンドケイコーポレーション',
    '株式会社ケーブルテレビ佐伯',
    '株式会社ケーブルテレビ可児',
    '株式会社ケーブルテレビ品川',
    '株式会社ケーブルネット鈴鹿',
    '株式会社コミュニティネットワークセンター',
    '株式会社コム',
    '株式会社サイバーウェイブジャパン',
    '株式会社サイバーエージェント',
    '株式会社サイバーリンクス',
    '株式会社サルード',
    '株式会社シックス',
    '株式会社シティーケーブル周南',
    '株式会社シナプス',
    '株式会社シーイーシー',
    '株式会社シーディーネットワークス・ジャパン',
    '株式会社シーポイント',
    '株式会社シー・アール',
    '株式会社ジェンマエンジニアリング',
    '株式会社ジュピターテレコム',
    '株式会社ジンオフィスサービス',
    '株式会社スクウェア・エニックス',
    '株式会社スマートバリュー',
    '株式会社スマート・インサイト',
    '株式会社セイトウ',
    '株式会社ゼクシス',
    '株式会社ダイバーシティメディア',
    '株式会社チロロネット',
    '株式会社テレビ松本ケーブルビジョン',
    '株式会社テレビ鳴門',
    '株式会社ディメンションデータジャパン',
    '株式会社ディレクターズ',
    '株式会社ディー・アイ・ジー',
    '株式会社ディー・エヌ・エー',
    '株式会社デジタルアライアンス',
    '株式会社データドック',
    '株式会社トヨタシステムズ',
    '株式会社トーカ',
    '株式会社ドワンゴ',
    '株式会社ドヴァ',
    '株式会社ニイカワポータル',
    '株式会社ニューメディア',
    '株式会社ニューメディア徳島',
    '株式会社ネクストアイ',
    '株式会社ネットアイアールディー',
    '株式会社ネットフォレスト',
    '株式会社ハイパー・システムズ',
    '株式会社ハンズ',
    '株式会社ハートネットワーク',
    '株式会社ヒューメイア',
    '株式会社ビデックス',
    '株式会社ビーピーエス',
    '株式会社ファミリーネット・ジャパン',
    '株式会社フィデッサ',
    '株式会社フェアーウェイ',
    '株式会社フォーチュン',
    '株式会社フジミック',
    '株式会社フューチャースピリッツ',
    '株式会社フーズネクスト',
    '株式会社ブロードバンドセキュリティ',
    '株式会社ブロードバンドタワー',
    '株式会社マイメディア',
    '株式会社マツケイ',
    '株式会社ミクシィ',
    '株式会社ミライコミュニケーションネットワーク',
    '株式会社メイテツコム',
    '株式会社メディアウォーズ',
    '株式会社メルカリ',
    '株式会社ラッキータウンテレビ',
    '株式会社ラット',
    '株式会社レオンテクノロジー',
    '株式会社レッドスピードネットワークス',
    '株式会社ワイヤレスゲート',
    '株式会社ワイヤ・アンド・ワイヤレス',
    '株式会社三次ケーブルビジョン',
    '株式会社三通',
    '株式会社上田ケーブルビジョン',
    '株式会社両毛インターネットデータセンター',
    '株式会社中海テレビ放送',
    '株式会社倉敷ケーブルテレビ',
    '株式会社八戸テレビ放送',
    '株式会社大垣ケーブルテレビ',
    '株式会社大塚商会',
    '株式会社富士通システムズアプリケーション＆サポート',
    '株式会社富士通鹿児島インフォネット',
    '株式会社広域高速ネット二九六',
    '株式会社御前崎ケーブルテレビ',
    '株式会社愛媛CATV',
    '株式会社新潟通信サービス',
    '株式会社日本ネットワークサービス',
    '株式会社日本レジストリサービス',
    '株式会社日立システムズ',
    '株式会社日立ソリューションズ',
    '株式会社日経統合システム',
    '株式会社朝日ネット',
    '株式会社沖縄データセンター',
    '株式会社秋田ケーブルテレビ',
    '株式会社縁通',
    '株式会社長崎ケーブルメディア',
    '株式会社長野県協同電算',
    '株式会社電算',
    '株式会社高知システムズ',
    '株式会社鳥取テレトピア',
    '株式会社ＣＲＣＣメディア',
    '株式会社ＤＵＮＡＭＩＳ',
    '株式会社ＩＣ?ＮＥＴ',
    '株式会社ＩＭＳ',
    '株式会社Ｊストリーム',
    '株式会社ＮＴＴぷらら',
    '株式会社ＮＴＴドコモ',
    '株式会社ＴＡＭ',
    '楽天コミュニケーションズ株式会社',
    '楽天モバイルネットワーク株式会社',
    '楽天株式会社',
    '沖縄クロス・ヘッド株式会社',
    '沖縄ケーブルネットワーク株式会社',
    '沖縄通信ネットワーク株式会社',
    '河口湖有線テレビ放送有限会社',
    '浜松ケーブルテレビ株式会社',
    '湘南ケーブルネットワーク株式会社',
    '特定非営利活動法人きたうら花ねっと',
    '玉島テレビ放送株式会社',
    '産業サイバーセキュリティセンター',
    '矢掛放送株式会社',
    '知多メディアスネットワーク株式会社',
    '知多半島ケーブルネットワーク株式会社',
    '石見ケーブルビジョン株式会社',
    '神河町',
    '秋田県',
    '笠岡放送株式会社',
    '群馬インターネット株式会社',
    '自宅NOCオペレーターズグループ',
    '茨城県',
    '萩ケーブルネットワーク株式会社',
    '蕨ケーブルビジョン株式会社',
    '西尾張シーエーティーヴィ株式会社',
    '西日本電信電話株式会社',
    '諫早ケーブルメディア株式会社',
    '豊島ケーブルネットワーク株式会社',
    '豊橋ケーブルネットワーク株式会社',
    '農林水産省農林水産技術会議事務局筑波産学連携支援センター',
    '鈴与シンワート株式会社',
    '長門市',
    '関西ブロードバンド株式会社',
    '関電システムソリューションズ株式会社',
    '防衛省',
    '青森ケーブルテレビ株式会社',
    '飛騨高山ケーブルネットワーク株式会社',
    '香川テレビ放送網株式会社',
    '高知県公立大学法人',
    '鹿沼ケーブルテレビ株式会社',
    'ＢＴＶ株式会社',
    'ＧＭＯインターネット株式会社',
]

def fix_file_path(tarStr):
    return re.sub(r'[\\|/|:|?|.|"|<|>|\|\*]', '_', tarStr) # "

def fix_unSJIS(tarStr):
    return tarStr.encode('SJIS','ignore').decode('SJIS')

def ip_range_search(target):
    if re.search('\d+?\.\d+?\.\d+?\.\d+',target):
        # IP addressで検索
        url  = 'https://whois.nic.ad.jp/cgi-bin/whois_gw?codecheck-sjis=%82%C9%82%D9%82%F1%82%CB%82%C1%82%C6%82%ED%81%5B%82%AD%82%A2%82%F1%82%D3%82%A7%82%DF%81%5B%82%B5%82%E5%82%F1%82%B9%82%F1%82%BD%81%5B&key=' + target + '&submit=%8C%9F%8D%F5&type=NET'
        pass
    else:
        # 組織名で検索
        org_name = urllib.parse.quote(target, encoding='sjis')
        url = 'https://whois.nic.ad.jp/cgi-bin/whois_gw?codecheck-sjis=%82%C9%82%D9%82%F1%82%CB%82%C1%82%C6%82%ED%81%5B%82%AD%82%A2%82%F1%82%D3%82%A7%82%DF%81%5B%82%B5%82%E5%82%F1%82%B9%82%F1%82%BD%81%5B&key=' + org_name + '&submit=&type=NET-HOLDER&rule='
        domain = '{uri.scheme}://{uri.netloc}'.format(uri=urlparse(url))
        print(target + '\t' + url)
        res = requests.get(url,headers=headers)
        soup = BeautifulSoup(res.content,'lxml')
        url
        for a in soup.find_all('a')[0:-1]:
            ip_net = a.text
            if ':' in ip_net:
                # 一旦、IPv6は無視
                continue
            elif '検索対象が広すぎます' in soup.text or '該当するデータがありません。' in soup.text or 'JP' in ip_net :
                f_err.write(url + '\n')
                continue
            elif '-' in ip_net:
                ip_s = ip_net.split('-')[0]
                ip_e = ip_net.split('-')[-1]
            else:
                ip_s = str(ipaddress.ip_network(ip_net)[0])
                ip_e = str(ipaddress.ip_network(ip_net)[-1])
            
            i = ip_s.split('.')
            deci_ip_s = (int(i[0]) << 24) + (int(i[1]) << 16) + (int(i[2]) << 8) + int(i[3])
            i = ip_e.split('.')
            deci_ip_e = (int(i[0]) << 24) + (int(i[1]) << 16) + (int(i[2]) << 8) + int(i[3])
            out = str(deci_ip_s) + '\t' + str(deci_ip_e) + '\t' + target
            f_out.write(out + '\n')
            print('\t\t' + out)

f_out = open('jp_org.tsv','a', encoding='sjis')
f_err = open('jp_org_err.tsv','a', encoding='sjis')
for target in tar_org:
    ip_range_search(target)
    time.sleep(random.choice(range(3,5)))

